{"id":7365,"date":"2021-02-26T16:45:19","date_gmt":"2021-02-27T00:45:19","guid":{"rendered":"https:\/\/joinhandshake.com\/?post_type=our-team&#038;p=7365"},"modified":"2021-02-26T16:45:20","modified_gmt":"2021-02-27T00:45:20","slug":"switching-to-buildkite","status":"publish","type":"our-team","link":"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/","title":{"rendered":"Blazing Fast CI with Buildkite"},"content":{"rendered":"\n<p><em><strong>Editor\u2019s note:<\/strong>\u00a0This article was originally published in October 2016, and was re-posted in February 2021.<\/em><\/p>\n\n\n\n<p>Handshake ships new code multiple times a day, continuously. This fast deployment pace allows us to build and maintain features quickly and safely, but also pushes infrastructure to new limits. One of these limits is the test suite. When doing continuous delivery, a fast test suite becomes paramount. As our CI continued to slow with new features and CI checks, we started to look into alternatives to our hosted CI solution, and we recently finished the full switch to Buildkite for our CI pipelines.<\/p>\n\n\n\n<h3 id=\"Slow-Test-Suites\">Slow test suites<\/h3>\n\n\n\n<p>Handshake has grown quite a bit over the past few years. We&#8217;ve seen our test suite go from 5 minutes on one container, to 15 minutes, back to 5 minutes on many containers, to upwards of 25 minutes on 6 containers at it&#8217;s most lengthy build time. Although 25 minutes not seem like a lot, it can feel like an eternity to an engineer in the flow. Quickly, 25 minutes per change can add up to an hour to the time-to-production; 25 minutes for the feature branch, and 25 more after merging into master. If we wanted to continue to move quickly, we knew we needed to address the problem and cut our test suite time drastically.<\/p>\n\n\n\n<h3 id=\"Why-so-slow?\">Why so slow?<\/h3>\n\n\n\n<p>When evaluating our test suite time there were a few obvious bottlenecks:<\/p>\n\n\n\n<p>Because we use some custom libraries not provided by our previous hosted CI, we needed to install new libraries on each build. Often times these could be cached, but not always, and as a result our fixed up-front cost for any build was&nbsp;<strong>7 minutes of installing libraries<\/strong>. These custom libraries ranged from new ruby versions that were not yet supported by the provider to upgraded qt for capybara-webkit to fix other issues such as flakey tests.<\/p>\n\n\n\n<p>The rest of the build process took around 18 minutes, most of that time being spent running the actual test.<\/p>\n\n\n\n<p>This meant that there were two ways to improve our build time. First, we wanted to cut the upfront cost as much as possible. We hoped to have a container with exactly the libraries relevant to us that we could control at a more granular level and re-use for every build. We also knew that by using more containers (parallelization) we could continue to cut down the build time; more containers = faster tests.<\/p>\n\n\n\n<h2 id=\"Solution:-Buildkite\">Solution: Buildkite<\/h2>\n\n\n\n<p>When we initially found Buildkite, it was unclear if they provided enough to be a viable solution. Buildkite&#8217;s approach to CI is &#8220;bring your own compute&#8221;. This means that although they provide the UI for viewing your tests, seeing test in-progress, editing your pipelines, and managing user accounts you provide the compute and infrastructure to actually run the tests. At first this feels like a steep task, but with great open source provided by Buildkite such as the elastic-ci-stack, it&#8217;s not nearly as difficult as it seems. We&#8217;ll get more into this later.<\/p>\n\n\n\n<p>We quickly started experimenting with buildkite. Smaller services could be configured and green within a few hours, and we had complete control over our CI environment. As we started moving more apps to Buildkite we quickly began to discover many of the benefits.<\/p>\n\n\n\n<h3 id=\"Fast-Compute,-Please\">Fast compute, please<\/h3>\n\n\n\n<p>One of the nice benefits of the &#8220;bring your own compute&#8221; approach is the ability to choose EC2 instances that work best for you. In our case, we opted for beefy ec2 instances that we could clearly tell from the get-go ran our tests faster. This was exciting &#8211; even without starting on cutting upfront cost or parallelizing, which was our original goals, we achieved faster CI times. This also had a nice side effect that javascript request specs were less flakey! Double-win.<\/p>\n\n\n\n<h3 id=\"Exact-Docker-Images\">Exact docker images<\/h3>\n\n\n\n<p>Next, we took advantage of the docker-compose functionality built into the beta build for buildkite. This plugin allows us to build the exact docker image we need for our tests and re-use that image later when running the actual tests. By using dedicated instances for building the docker images, we can take advantage of docker&#8217;s caching functionality. This means that for a normal build our upfront cost for our docker images is merely the time it takes to upload and download the changed code from dockerhub, and a few initializations of services like postgres schema load. In most cases, our <strong>test containers start running tests in about 1.5 minutes<\/strong> &#8211; including docker image upload\/download, starting services like postgres, schema load and precompiling all assets. The majority of that time (roughly one minute) is spent in uploading changed layers to docker hub, a time we hope to cut down even further.<\/p>\n\n\n\n<h3 id=\"All-the-Containers!\">All the containers!<\/h3>\n\n\n\n<p>Suddenly we were living in a new type of world. Instead of each container spending 7 minutes before it can run any tests, our test running containers spend merely 30 seconds before they are being productive. This means that containers cycle in and out much faster, and even with roughly the same number of containers on our old provider we can parellize our Buildkite builds much more without the queue backing up. Previously we were running only 6 containers per build, and the queue would backup on a regular basis. With buildkite we are running&nbsp;<strong>16 containers in parallel<\/strong> for our Rspec tests, plus 3 other containers for some additional CI, and&nbsp;our queue&nbsp;<strong>rarely backs up<\/strong> because tests run quickly and move on!<\/p>\n\n\n\n<h2 id=\"Fast-Feedback\">Fast feedback<\/h2>\n\n\n\n<p>What does all of this mean for our build times? <strong>Our builds now finish in around 8 minutes!&nbsp;<\/strong>This has had drastic positive benefits<\/p>\n\n\n\n<ul><li>No longer do engineers have to context switch when waiting for CI<\/li><li>Hotfixes can get out considerably faster, usually in around 20 minutes if running both feature branch CI and master CI.<\/li><\/ul>\n\n\n\n<p>We&#8217;ve also seen benefits through using Buildkite&#8217;s more expressive and customizable pipeline structure. We can get feedback on other parts of CI, such as brakeman and bundle-audit, in around 2 minutes.<\/p>\n\n\n\n<h2 id=\"Tips-for-Migration\">Tips for migration<\/h2>\n\n\n\n<p>Are you thinking about giving Buildkite a try? Here&#8217;s a few thigns that worked well for us.<\/p>\n\n\n\n<ul><li>Use elastic-ci-stack: It gives you a highly scalable, easy to manage CI infrastructure in minutes.<\/li><li>Use the docker-compose plugin provided by the beta build<\/li><li>Make sure you use quality ec2 instances. Not only do they speed up your builds, but they make them more reliable<\/li><li>Get the whole team on board. Switching CI&#8217;s is no small task, and ensure that your new CI is clearly at a point where it is better than your previous. If coworkers are still using the old CI while you&#8217;re moving towards the new one, there&#8217;s probably a reason.<\/li><li>Use spot instances for cheaper ec2 instances, but make sure to bid high enough so builds don&#8217;t lose their instances.<\/li><\/ul>\n\n\n\n<h2 id=\"Conclusion\">Conclusion<\/h2>\n\n\n\n<p>Switching to Buildkite has been an exciting and productive process. Although running your own build infrastructure comes with a maintenance cost, the benefits across the rest of your team can be huge. Being in a position of continuing to cut buildtime by simply adding more compute is powerful. Looking forward we plan to continue to cut down the fixed cost by reducing docker image size (if possible) and optimizing our docker layer structure.<\/p>\n\n\n\n<p><em>Photo by\u00a0<a href=\"https:\/\/www.pexels.com\/@divinetechygirl?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels\" target=\"_blank\" rel=\"noreferrer noopener\">Christina Morillo<\/a>\u00a0from\u00a0<a href=\"https:\/\/www.pexels.com\/photo\/two-people-holding-macbook-pro-1181275\/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels\" target=\"_blank\" rel=\"noreferrer noopener\">Pexels<\/a><\/em><\/p>\n","protected":false},"excerpt":{"rendered":"<p>Engineer Scott Ringwelski recaps Handshake&#8217;s switch to Buildkite for our CI pipelines. <\/p>\n","protected":false},"author":167034976,"featured_media":7367,"menu_order":0,"template":"","our_team_category":[1615],"our_team_tag":[1539,1648],"yoast_head":"<!-- This site is optimized with the Yoast SEO plugin v16.8 - https:\/\/yoast.com\/wordpress\/plugins\/seo\/ -->\n<title>Blazing Fast CI with Buildkite | Handshake<\/title>\n<meta name=\"description\" content=\"Company co-founder and engineer Scott Ringwelski recaps Handshake&#039;s switch to Buildkite for our CI pipelines.\" \/>\n<meta name=\"robots\" content=\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\" \/>\n<link rel=\"canonical\" href=\"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/\" \/>\n<meta property=\"og:locale\" content=\"en_US\" \/>\n<meta property=\"og:type\" content=\"article\" \/>\n<meta property=\"og:title\" content=\"Blazing Fast CI with Buildkite | Handshake\" \/>\n<meta property=\"og:description\" content=\"Company co-founder and engineer Scott Ringwelski recaps Handshake&#039;s switch to Buildkite for our CI pipelines.\" \/>\n<meta property=\"og:url\" content=\"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/\" \/>\n<meta property=\"og:site_name\" content=\"Handshake\" \/>\n<meta property=\"article:publisher\" content=\"https:\/\/www.facebook.com\/joinhandshake\" \/>\n<meta property=\"article:modified_time\" content=\"2021-02-27T00:45:20+00:00\" \/>\n<meta property=\"og:image\" content=\"https:\/\/i2.wp.com\/joinhandshake.com\/wp-content\/uploads\/2021\/05\/HS_Web_Sharing-Cover.jpg?fit=1801%2C946&#038;ssl=1\" \/>\n\t<meta property=\"og:image:width\" content=\"1801\" \/>\n\t<meta property=\"og:image:height\" content=\"946\" \/>\n<meta name=\"twitter:card\" content=\"summary_large_image\" \/>\n<meta name=\"twitter:site\" content=\"@joinhandshake\" \/>\n<meta name=\"twitter:label1\" content=\"Est. reading time\" \/>\n\t<meta name=\"twitter:data1\" content=\"6 minutes\" \/>\n<script type=\"application\/ld+json\" class=\"yoast-schema-graph\">{\"@context\":\"https:\/\/schema.org\",\"@graph\":[{\"@type\":\"Organization\",\"@id\":\"https:\/\/joinhandshake.com\/#organization\",\"name\":\"Handshake\",\"url\":\"https:\/\/joinhandshake.com\/\",\"sameAs\":[\"https:\/\/www.facebook.com\/joinhandshake\",\"https:\/\/www.instagram.com\/joinhandshake\",\"https:\/\/www.linkedin.com\/company\/team-handshake\/\",\"https:\/\/twitter.com\/joinhandshake\"],\"logo\":{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/joinhandshake.com\/#logo\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/i1.wp.com\/joinhandshake.com\/wp-content\/uploads\/2019\/11\/handshake-share.png?fit=1200%2C628&ssl=1\",\"contentUrl\":\"https:\/\/i1.wp.com\/joinhandshake.com\/wp-content\/uploads\/2019\/11\/handshake-share.png?fit=1200%2C628&ssl=1\",\"width\":1200,\"height\":628,\"caption\":\"Handshake\"},\"image\":{\"@id\":\"https:\/\/joinhandshake.com\/#logo\"}},{\"@type\":\"WebSite\",\"@id\":\"https:\/\/joinhandshake.com\/#website\",\"url\":\"https:\/\/joinhandshake.com\/\",\"name\":\"Handshake\",\"description\":\"\",\"publisher\":{\"@id\":\"https:\/\/joinhandshake.com\/#organization\"},\"potentialAction\":[{\"@type\":\"SearchAction\",\"target\":{\"@type\":\"EntryPoint\",\"urlTemplate\":\"https:\/\/joinhandshake.com\/?s={search_term_string}\"},\"query-input\":\"required name=search_term_string\"}],\"inLanguage\":\"en-US\"},{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/#primaryimage\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/i0.wp.com\/joinhandshake.com\/wp-content\/uploads\/2021\/02\/pexels-christina-morillo-1181275.jpg?fit=6016%2C4016&ssl=1\",\"contentUrl\":\"https:\/\/i0.wp.com\/joinhandshake.com\/wp-content\/uploads\/2021\/02\/pexels-christina-morillo-1181275.jpg?fit=6016%2C4016&ssl=1\",\"width\":6016,\"height\":4016},{\"@type\":\"WebPage\",\"@id\":\"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/#webpage\",\"url\":\"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/\",\"name\":\"Blazing Fast CI with Buildkite | Handshake\",\"isPartOf\":{\"@id\":\"https:\/\/joinhandshake.com\/#website\"},\"primaryImageOfPage\":{\"@id\":\"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/#primaryimage\"},\"datePublished\":\"2021-02-27T00:45:19+00:00\",\"dateModified\":\"2021-02-27T00:45:20+00:00\",\"description\":\"Company co-founder and engineer Scott Ringwelski recaps Handshake's switch to Buildkite for our CI pipelines.\",\"breadcrumb\":{\"@id\":\"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/#breadcrumb\"},\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"ReadAction\",\"target\":[\"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/\"]}]},{\"@type\":\"BreadcrumbList\",\"@id\":\"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/#breadcrumb\",\"itemListElement\":[{\"@type\":\"ListItem\",\"position\":1,\"name\":\"Home\",\"item\":\"https:\/\/joinhandshake.com\/\"},{\"@type\":\"ListItem\",\"position\":2,\"name\":\"Blazing Fast CI with Buildkite\"}]}]}<\/script>\n<!-- \/ Yoast SEO plugin. -->","yoast_head_json":{"title":"Blazing Fast CI with Buildkite | Handshake","description":"Company co-founder and engineer Scott Ringwelski recaps Handshake's switch to Buildkite for our CI pipelines.","robots":{"index":"index","follow":"follow","max-snippet":"max-snippet:-1","max-image-preview":"max-image-preview:large","max-video-preview":"max-video-preview:-1"},"canonical":"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/","og_locale":"en_US","og_type":"article","og_title":"Blazing Fast CI with Buildkite | Handshake","og_description":"Company co-founder and engineer Scott Ringwelski recaps Handshake's switch to Buildkite for our CI pipelines.","og_url":"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/","og_site_name":"Handshake","article_publisher":"https:\/\/www.facebook.com\/joinhandshake","article_modified_time":"2021-02-27T00:45:20+00:00","og_image":[{"width":1801,"height":946,"url":"https:\/\/i2.wp.com\/joinhandshake.com\/wp-content\/uploads\/2021\/05\/HS_Web_Sharing-Cover.jpg?fit=1801%2C946&ssl=1","path":"\/srv\/htdocs\/wp-content\/uploads\/2021\/05\/HS_Web_Sharing-Cover.jpg","size":"full","id":9282,"alt":"","pixels":1703746,"type":"image\/jpeg"}],"twitter_card":"summary_large_image","twitter_site":"@joinhandshake","twitter_misc":{"Est. reading time":"6 minutes"},"schema":{"@context":"https:\/\/schema.org","@graph":[{"@type":"Organization","@id":"https:\/\/joinhandshake.com\/#organization","name":"Handshake","url":"https:\/\/joinhandshake.com\/","sameAs":["https:\/\/www.facebook.com\/joinhandshake","https:\/\/www.instagram.com\/joinhandshake","https:\/\/www.linkedin.com\/company\/team-handshake\/","https:\/\/twitter.com\/joinhandshake"],"logo":{"@type":"ImageObject","@id":"https:\/\/joinhandshake.com\/#logo","inLanguage":"en-US","url":"https:\/\/i1.wp.com\/joinhandshake.com\/wp-content\/uploads\/2019\/11\/handshake-share.png?fit=1200%2C628&ssl=1","contentUrl":"https:\/\/i1.wp.com\/joinhandshake.com\/wp-content\/uploads\/2019\/11\/handshake-share.png?fit=1200%2C628&ssl=1","width":1200,"height":628,"caption":"Handshake"},"image":{"@id":"https:\/\/joinhandshake.com\/#logo"}},{"@type":"WebSite","@id":"https:\/\/joinhandshake.com\/#website","url":"https:\/\/joinhandshake.com\/","name":"Handshake","description":"","publisher":{"@id":"https:\/\/joinhandshake.com\/#organization"},"potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https:\/\/joinhandshake.com\/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/#primaryimage","inLanguage":"en-US","url":"https:\/\/i0.wp.com\/joinhandshake.com\/wp-content\/uploads\/2021\/02\/pexels-christina-morillo-1181275.jpg?fit=6016%2C4016&ssl=1","contentUrl":"https:\/\/i0.wp.com\/joinhandshake.com\/wp-content\/uploads\/2021\/02\/pexels-christina-morillo-1181275.jpg?fit=6016%2C4016&ssl=1","width":6016,"height":4016},{"@type":"WebPage","@id":"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/#webpage","url":"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/","name":"Blazing Fast CI with Buildkite | Handshake","isPartOf":{"@id":"https:\/\/joinhandshake.com\/#website"},"primaryImageOfPage":{"@id":"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/#primaryimage"},"datePublished":"2021-02-27T00:45:19+00:00","dateModified":"2021-02-27T00:45:20+00:00","description":"Company co-founder and engineer Scott Ringwelski recaps Handshake's switch to Buildkite for our CI pipelines.","breadcrumb":{"@id":"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/"]}]},{"@type":"BreadcrumbList","@id":"https:\/\/joinhandshake.com\/blog\/our-team\/switching-to-buildkite\/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/joinhandshake.com\/"},{"@type":"ListItem","position":2,"name":"Blazing Fast CI with Buildkite"}]}]}},"jetpack_sharing_enabled":true,"_links":{"self":[{"href":"https:\/\/joinhandshake.com\/wp-json\/wp\/v2\/our-team\/7365"}],"collection":[{"href":"https:\/\/joinhandshake.com\/wp-json\/wp\/v2\/our-team"}],"about":[{"href":"https:\/\/joinhandshake.com\/wp-json\/wp\/v2\/types\/our-team"}],"author":[{"embeddable":true,"href":"https:\/\/joinhandshake.com\/wp-json\/wp\/v2\/users\/167034976"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/joinhandshake.com\/wp-json\/wp\/v2\/media\/7367"}],"wp:attachment":[{"href":"https:\/\/joinhandshake.com\/wp-json\/wp\/v2\/media?parent=7365"}],"wp:term":[{"taxonomy":"our_team_category","embeddable":true,"href":"https:\/\/joinhandshake.com\/wp-json\/wp\/v2\/our_team_category?post=7365"},{"taxonomy":"our_team_tag","embeddable":true,"href":"https:\/\/joinhandshake.com\/wp-json\/wp\/v2\/our_team_tag?post=7365"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}